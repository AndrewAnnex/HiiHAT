<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:29 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_get_neutral_region.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_get_neutral_region.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+ </span>
<span class="comments">; Detects a neutral spectrum within the given image and creates a ratio</span>
<span class="comments">; image by dividing out the detected spectrum.</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;  preprocessing</span>
<span class="comments">;</span>
<span class="comments">; :Author: David Ray Thompson</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;  img_fid: in, required, type=fix</span>
<span class="comments">;    file id for input image data</span>
<span class="comments">;  seg_fid: in, required, type=fix</span>
<span class="comments">;    file id for input image segmentation map</span>
<span class="comments">;  roi_out_id: out, optional, type=fix</span>
<span class="comments">;    file id of output roi file</span>
<span class="comments">;  spectrum_out_filename: out, optional, type=string</span>
<span class="comments">;    filename to save output spectrum</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;  Copyright 2009, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_get_neutral_region:source"></a>pro hiihat_get_neutral_region, img_fid=img_fid, seg_fid=seg_fid, $
                             roi_out_id = roi_out_id, $
                             spectrum_out_filename=spectrum_out_filename, $
                             ratioed_out_filename=ratioed_out_filename, $
                             r_fid=spectrum_fid, $
                             coalesce_threshold=coalesce_threshold, $
                             use_dims = use_dims, $
                             neutral_spectrum = neutral_spectrum, $
                             spectrum_best = spectrum, $
                             best_segment_id = best_segment_id,$
                             verbose = verbose


    <span class="comments">;Set compiler and debug options</span>
    compile_opt IDL2
    debug = hiihat_get_config_parm('debug')
    if not keyword_set(verbose) then verbose = 0
    if not keyword_set(ratioed_out_filename) then ratioed_out_filename = ""

    title='hiihat_get_neutral_region'
    if debug then print, "Entering "+title

    <span class="comments">; Create the progress bar.</span>
    envi_report_init, "Neutral region detection.", base=base, /INTERRUPT, title=title 
    envi_report_inc, base, 100
    

    hiihat_segment_spectra, img_fid, seg_fid, spectra=spectra, $
                            use_dims = use_dims, verbose=verbose

    <span class="comments">; find best fit polynomial</span>
    n_segments = (size(spectra))[1]
    n_bands = (size(spectra))[2]
    
    <span class="comments">; build data matrix</span>
    best_residual = 9e99
    best_spectrum = 0
    best_segment_num = -1
    min_noise_level = 1e-9

    <span class="comments">; get segment extent information for excluding large regions</span>
    max_segment_size = 10000 <span class="comments">; a region bigger than we'd ever want</span>

    seg_ns = use_dims[2]-use_dims[1]+1
    seg_nl = use_dims[4]-use_dims[3]+1
    seg_nb = 1
    seg_dims = use_dims
    <span class="comments">;envi_file_query, seg_fid, nb=seg_nb, ns=seg_ns, nl=seg_nl, dims=seg_dims</span>
    segments = envi_get_data(fid=seg_fid, dims=seg_dims, pos = [0]) 

    <span class="comments">;; Search for pathological regions of</span>
    <span class="comments">;; the spectra that should be ignored</span>
    <span class="comments">;; in the fit calculation</span>
    badbands = intarr(n_bands)
    for i=0,n_segments-1 do begin
        zero_ids = where(spectra[i,*] eq 0)
        if zero_ids[0] gt -1 then badbands[zero_ids]=1
        infinite_ids = where(finite(spectra[i,*]) eq 0)
        if infinite_ids[0] gt -1 then badbands[infinite_ids]=1
    endfor <span class="comments">; walk segments searching for pathological regions</span>
    goodbands = 1 - badbands
    n_goodbands = total(goodbands)
    goodbands_idx = where(goodbands eq 1)
    print, "Bad bands found:",where(badbands eq 1)
 
    for i=0,n_segments-1 do begin
        if i mod 20 eq 0 then begin
              envi_report_stat, base, i/(n_segments-1), 100, cancel=cancel                                             
              if cancel then begin
                 goto, cleanup
              endif
        endif


        <span class="comments">; fit a low-degree polynomial to the spectrum (least squares)</span>
        <span class="comments">; We do not penalize for pathological regions previously determined</span>
        x = indgen(n_goodbands)
        A = [[x], [fltarr(n_goodbands)+1.0]]
        y = transpose(spectra[i,goodbands_idx]+1)
        y = y / total(y) <span class="comments">; L1-normalize</span>
        pinv = invert(transpose(A) # A) # transpose(A) 
        b = pinv # y

        <span class="comments">; exclude really big regions</span>
        indices = array_indices(segments, where(segments eq i))
        n_pix = n_elements(indices)
        if (n_pix gt max_segment_size) then continue

        <span class="comments">; get the residual</span>
        residual = total(((A # b) - y)^2)
        if (residual lt min_noise_level) then continue

        if (residual lt best_residual) then begin
            best_residual = residual 
            best_spectrum = i
            best_segment_num = i
        endif
    endfor

    if keyword_set(best_segment_id) then best_segment_id = best_segment_num
    
    <span class="comments">;load in the appropriate wavelengths to show on the x axis</span>
    envi_file_query, img_fid, wl = wavelengths

                                <span class="comments">;return the actual best neutral</span>
                                <span class="comments">;spectrum, not the compressed</span>
                                <span class="comments">;good-band-only version</span>
    if keyword_set(neutral_spectrum) then begin
        neutral_spectrum = spectra[best_spectrum,*]
    endif

    envi_report_stat, base, 100, 100

    <span class="comments">; write spectrum</span>
    if (spectrum_out_filename ne "") then begin
        dims = [-1,0,0,n_bands-1,0]
        envi_write_envi_file, spectra[best_spectrum,*], r_fid=temp_fid, dims=dims, $
          data_type=data_type, nb=1, ns=n_bands, nl=1, $
          out_name = spectrum_out_filename, wl=wavelengths, $ 
          wavelength_units=wu, spec_names = ['neutral spectrum'],$ 
          file_type = envi_file_type("ENVI Spectral Library"), /no_open
                                <span class="comments">;Do the dance to prevent the available</span>
                                <span class="comments">;bands menu from popping up</span>
        envi_file_mng, id = temp_fid, /remove
        envi_open_file, spectrum_out_filename, r_fid = temp_fid, /no_realize
    endif

    if (keyword_set(spectrum)) then spectrum = spectra[best_spectrum,*]

    ns_endmembers = n_bands
    nl_endmembers = 1

    <span class="comments">; get image dimensions </span>
    envi_file_query, img_fid, ns=ns, nl=nl, nb=nb, dims=dims

    <span class="comments">; load superpixels</span>
    envi_file_query, seg_fid, nb=seg_nb, ns=seg_ns, nl=seg_nl, dims=seg_dims
    segments = envi_get_data(fid=seg_fid, dims=seg_dims, pos = [0]) 
    n_segments = max(segments)+1 <span class="comments">; assume consecutate labels, start w/zero </span>
        
    <span class="comments">; define the ROI, write to file</span>
    new_roi_id = envi_create_roi(color=7, name='Neutral Spectrum', $
                                 ns=ns, nl=nl)
    r_roi_id = new_roi_id
    pts = where(segments eq best_spectrum)
    subsection_ns = use_dims[2] - use_dims[1] + 1 
    ypts = floor(pts /   subsection_ns) + use_dims[3]
    xpts =       pts mod subsection_ns  + use_dims[1]
    envi_define_roi, new_roi_id, /point, xpts=xpts, ypts=ypts
    roi_out_id = new_roi_id

    <span class="comments">; write ratioed image</span>
    if (ratioed_out_filename ne "") then begin
        ratioed = fltarr(ns, nl, nb)
        for j=0,nb-1 do begin
           envi_report_stat, base, j, nb-1, cancel=cancel   
           if cancel then goto, cleanup     
           ratioed[*,*,j] = envi_get_data(fid=img_fid,dims=dims, pos=j)/$
               spectra[best_spectrum,j]
        endfor
        envi_write_envi_file, ratioed, r_fid=temp_fid, dims=dims, $
          data_type=data_type, nb=nb, ns=ns, nl=nl, $
          out_name = ratioed_out_filename, wl=wavelengths, $ 
          wavelength_units=wu, /no_open
        envi_open_file, ratioed_out_filename, r_fid = temp_fid, /no_realize
    endif

cleanup:
    envi_report_init, base=base, /finish <span class="comments">;; close statusbar</span>
    if debug then print, "Exiting "+title
end
  

</code>
    </div>
  </body>
</html>