<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:31 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_endmember_ask_params.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_endmember_ask_params.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; Query user for endmember detection parameters</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;   ui </span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;   coalesce_threshold: in, optional, type=fix</span>
<span class="comments">;     SMACC only, maximum Spectral Angle Mapper (SAM) </span>
<span class="comments">;     threshold above which endmember spectra are considered unique </span>
<span class="comments">;     (angle/1000), in range [0,1000], values outside range set to nearest bound</span>
<span class="comments">;   n_endmembers: in, required, type=fix</span>
<span class="comments">;     number of endmembers in range [1,30]</span>
<span class="comments">;   method: in, required, type=string</span>
<span class="comments">;     detection method, one of 'NFINDR' or 'SMACC'</span>
<span class="comments">;  out_filename: out, required, type=string</span>
<span class="comments">;    file name of output spectral librar</span>
<span class="comments">;  in_memory: out, optional, type=boolean</span>
<span class="comments">;    store endmember rois and library in memory</span>
<span class="comments">;  roi_out_filename: out, required, type=string</span>
<span class="comments">;    file name of output roi file</span>
<span class="comments">;  base_filename: in, optional, type=string</span>
<span class="comments">;    base name of image file to segment, if available</span>
<span class="comments">;   endmember_cancel: out, required, type=boolean</span>
<span class="comments">;     true if user cancels endmember detection</span>
<span class="comments">;</span>
<span class="comments">; :Examples:</span>
<span class="comments">;   hiihat_endmember_ask_params, coalesce_threshold=50, </span>
<span class="comments">;                              n_endmembers=10, method='NFINDR', </span>
<span class="comments">;                              endmember_cancel=endmember_cancel</span>
<span class="comments">; </span>
<span class="comments">; :History:</span>
<span class="comments">;   2009 (DRT): Initial implementation.</span>
<span class="comments">;</span>
<span class="comments">;   Dec 14, 2010 (BDB): Added docstr.</span>
<span class="comments">;</span>
<span class="comments">; :Author: David Ray Thompson</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;  Copyright 2009, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_endmember_ask_params:source"></a>pro hiihat_endmember_ask_params, coalesce_threshold=coalesce_threshold, $ <span class="comments">;seg_fid=seg_fid, $</span>
                                 n_endmembers = n_endmembers, method = method, $
                                 out_filename = out_filename, base_filename=base_filename, $
                                 roi_out_filename=roi_out_filename, in_memory=in_memory, $
                                 endmember_cancel=endmember_cancel
    compile_opt strictarr

    debug = hiihat_get_config_parm('debug')
    gui_status = hiihat_get_config_parm('gui_status')

    title='hiihat_endmember_ask_params'
    if debug then print, "Entering "+title

    if not keyword_set(base_filename) then begin 
       def_filename='hiihat_endm'
    endif else begin
       def_filename=hiihat_strreplace(base_filename,'.img','',ignore_case=1)+'_endm'
    endelse

    n_endmembers = 10
    coalesce_threshold = 0.0

    <span class="comments">;; don't cancel unless user bails out</span>
    endmember_cancel=0

    methods=['SMACC','NFINDR']

    <span class="comments">; dialog to get SMACC parameters (code from ENVI documentation)</span>
    base = widget_auto_base(title='Endmember Parameters')  
    <span class="comments">;nil = widget_outf(base, prompt="Segmentation file (optional)", $</span>
    <span class="comments">;                  uvalue='seg_filename', /auto)</span>
    nil = widget_sslider(base, title='Number of endmembers', min=1, max=30, $  
                         value=10, uvalue='n_endmembers', /auto)  
    nil = widget_pmenu(base, prompt='Method', list=methods, uvalue = 'method', /auto )
    nil = widget_param(base, prompt='SMACC Coalescence Threshold (Angle / 1000)', $
                       floor=0, ceil=1000, dt=3, default='0', uvalue='coalesce_threshold', /auto)
    nil = widget_outf(base, prompt="Endmember Outfile (required)", $
                      uvalue='out_filename', default=def_filename+'.sli', /auto)
    nil = widget_outf(base, prompt="ROI Outfile (required)", $
                      uvalue='roi_out_filename', default=def_filename+'.roi', /auto)

    result = auto_wid_mng(base)  
    if result.accept eq 0 then begin
       endmember_cancel=1
       goto, cleanup
    endif

    <span class="comments">;; open segmentation file if available</span>
    <span class="comments">;envi_open_file, result.seg_filename, r_fid=seg_fid  </span>

    n_endmembers = result.n_endmembers
    coalesce_threshold = float(result.coalesce_threshold) / 1000.0
    method = methods[result.method]  
    out_filename = result.out_filename
    write_status = hiihat_check_file(out_filename,write=1)
    if write_status eq 0 then begin
       dialog='Endmember detection cancelled: Cannot write to outfile: '+out_filename
       if not gui_status then print,dialog else ok=dialog_message(dialog,title=title)
       endmember_cancel=1
       goto, cleanup
    endif else if write_status eq 2 then begin
       dialog='File "'+out_filename+'" exists, overwrite?'
       ok = dialog_message(dialog, title=title, /cancel)
       if (strupcase(ok) eq 'CANCEL') then begin 
          endmember_cancel=1
          goto, cleanup
       endif
    endif

    roi_out_filename = result.roi_out_filename
    write_status = hiihat_check_file(roi_out_filename,write=1)
    if write_status eq 0 then begin
       dialog='Endmember detection cancelled: Cannot write to ROI outfile: '+roi_out_filename
       if not gui_status then print,dialog else ok=dialog_message(dialog,title=title)
       endmember_cancel=1
       goto, cleanup
    endif else if write_status eq 2 then begin
       dialog='File "'+roi_out_filename+'" exists, overwrite?'
       ok = dialog_message(dialog, title=title, /cancel)
       if (strupcase(ok) eq 'CANCEL') then begin 
          endmember_cancel=1
          goto, cleanup
       endif
    endif    

cleanup:
    if debug then print, "Exiting "+title
end
</code>
    </div>
  </body>
</html>