<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:33 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_transform_ask_params.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_transform_ask_params.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+ </span>
<span class="comments">; Select a pre-computed transformation matrix for application to a</span>
<span class="comments">; known image format</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;  ui</span>
<span class="comments">;</span>
<span class="comments">; :Params: </span>
<span class="comments">;  image_type: in, required, type=string</span>
<span class="comments">;    Image type to transform, from hiihat_pp description provided in hdr file</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;  trans_filename: out, required, type=string</span>
<span class="comments">;    transfomation matrix filename</span>
<span class="comments">;  in_memory: out, optional, type=boolean</span>
<span class="comments">;    store transformed image in memory</span>
<span class="comments">;  base_filename: in, optional, type=string</span>
<span class="comments">;    base file name to assign to output image</span>
<span class="comments">;  out_filename: out, optional, type=string</span>
<span class="comments">;    name of file in which to save transformed image</span>
<span class="comments">;  max_rank: in, optional, type=fix</span>
<span class="comments">;    maximum rank of output transform (default = 5)</span>
<span class="comments">;  base_filename: in, optional, type=string</span>
<span class="comments">;    prefix to append to output filenames if available</span>
<span class="comments">;  transform_cancel: in, required, type=boolean</span>
<span class="comments">;    user selected cancel</span>
<span class="comments">;</span>
<span class="comments">; :Author: Brian D. Bue</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;  Copyright 2011, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_transform_ask_params:source"></a>pro hiihat_transform_ask_params, image_type, trans_filename=trans_filename, $
                                 out_filename=out_filename, in_memory=in_memory, $
                                 max_rank=max_rank, base_filename=base_filename, $
                                 verbose=verbose, transform_cancel=transform_cancel

  title='hiihat_transform_ask_params'  

  debug =  hiihat_get_config_parm('debug')
  if debug then print, "Entering "+title
  gui_status = hiihat_get_config_parm('gui_status')

  transform_cancel = 0

  if not keyword_set(base_filename) then begin 
     def_filename='hiihat_transform_preprocessed'
  endif else begin
     def_filename=hiihat_strreplace(base_filename,'.img','',ignore_case=1)+'_lda'
  endelse   

  <span class="comments">;; identify file prefix of transformation matrix  </span>
  case image_type of 
     'CRISM FRT (CAT-processed)': begin
        file_prefix = 'crism_frt_cat'
     end
     'CRISM MRDR (CAT-processed)': begin
        file_prefix = 'crism_mrdr_cat'
     end
     'CRISM MSW (CAT-processed)': begin
        file_prefix = 'crism_msw_cat'
     end
     'CRISM MSP (CAT-processed)': begin
        file_prefix = 'crism_msp_cat'
     end
     'M3 L1B RDN (raw)': begin
        file_prefix = 'm3_l1b_rdn'
     end
     'USGS AVIRIS reflectance': begin
        file_prefix = 'aviris_rfl'
     end
     'EO-1 Hyperion 10-band': begin
        file_prefix = 'eo1_10b'
     end
     'EO-1 Hyperion 12-band': begin
        file_prefix = 'eo1_12b'
     end
     'Generic': begin
        file_prefix = 'gen' 
     end
     'Unknown': begin
        file_prefix = '*' <span class="comments">;; user chose to continue despite lack of hiihat_pp flag</span>
     end
     else: begin
        dialog='Unrecognized image type'
        if not gui_status then print, dialog else ok=dialog_message(dialog,title=title)                                      
        transform_cancel = 1
        goto, cleanup
     end
  endcase

  <span class="comments">;; list all the files in the transforms directory with the proper prefix</span>
  hiihat_path = hiihat_get_config_parm('hiihat_path')
  sep = path_sep()
  data_path = hiihat_path+sep+'data'+sep+'transforms'+sep

  <span class="comments">;; list all the files (without the .hdr suffix)</span>
  trans_files = file_basename(file_search(data_path+file_prefix+'*'),'.hdr')
  
  trans_files = trans_files[uniq(trans_files,sort(trans_files))]
  if trans_files[0] eq '' then begin
     if verbose then print, 'No transformations for image type: "'+image_type+'."'
     transform_cancel=1
     goto, cleanup
  endif

  max_rank = 5 <span class="comments">;; default max rank parameter</span>

  <span class="comments">;; choose the transformation file</span>
  base = widget_auto_base(title='Transformation Parameters')  
  nil = widget_pmenu(base, prompt='Existing transformations:', $
                     list=trans_files, uvalue='trans_index',default=0,/auto)
  nil = widget_param(base, dt=3, field=3, floor=0., default=string(max_rank), $
                     prompt='Maximum Rank', uvalue='max_rank', /auto)  
  nil = widget_outfm(base, prompt="Output image file", uvalue='outf', $
                     default=def_filename+'.img', /auto)
  result = auto_wid_mng(base)  
  
  if (result.accept eq 0) then begin
     transform_cancel = 1
     goto, cleanup  
  endif

  max_rank = float(result.max_rank)


  <span class="comments">;; get transform file</span>
  trans_filename = data_path+trans_files[result.trans_index]
  read_status = hiihat_check_file(trans_filename,read=1)
  if read_status eq 0 then begin
     dialog = "Unable to read input file "+trans_filename
     if not gui_status then print,dialog else ok=dialog_message(dialog,title=title)
     transform_cancel=1
     goto, cleanup
  endif

  <span class="comments">;; select an output file</span>
  in_memory = result.outf.in_memory
  if not in_memory then begin
     out_filename = result.outf.name 
     write_status = hiihat_check_file(out_filename,write=1)
     if write_status eq 0 then begin
        dialog = "Invalid output file, computing in memory"
        if not gui_status then print,dialog else ok=dialog_message(dialog,title=title)
        in_memory=1
     endif else if write_status eq 2 then begin
        ok = dialog_message('File "'+out_filename+'" exists, overwrite?', $
                            title=title, /cancel)
        if (strupcase(ok) eq 'CANCEL') then begin
           transform_cancel=1
           goto, cleanup
        endif
     endif
  endif


cleanup:
  if debug then print, "Exiting "+title
end
</code>
    </div>
  </body>
</html>