<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:32 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_event_get_superpixel_endmembers.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_event_get_superpixel_endmembers.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+ </span>
<span class="comments">; Event callback for superpixel endmember detection menu option.</span>
<span class="comments">;</span>
<span class="comments">; :Author: David Ray Thompson</span>
<span class="comments">;</span>
<span class="comments">; :Categories: </span>
<span class="comments">;  ui</span>
<span class="comments">;</span>
<span class="comments">; :Params:</span>
<span class="comments">;  ev: in, required, type=event</span>
<span class="comments">;   input event</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;  Copyright 2009, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_event_get_superpixel_endmembers:source"></a>pro hiihat_event_get_superpixel_endmembers, ev 

    <span class="comments">;Set compiler and debug options</span>
    compile_opt idl2
    debug = hiihat_get_config_parm('debug')
    verbose = hiihat_get_config_parm('verbose')
    gui_status = hiihat_get_config_parm('gui_status')

    title='hiihat_event_get_superpixel_endmembers'
    if debug then print, 'Entering '+title

    <span class="comments">; load an image</span>
    envi_select, fid=img_fid, title="Select an input image", dims = use_dims, $
      /NO_SPEC
    if (img_fid eq -1) then begin
       if verbose then print, 'Invalid input image'
       goto, cleanup
    endif
    envi_file_query, img_fid, fname=img_fname

    <span class="comments">;; select a segmentation image </span>
    dialog="Select a segmentation, or 'cancel' to recompute"
    envi_select, fid=seg_fid, title=dialog, /NO_DIMS, /NO_SPEC

    hiihat_endmember_ask_params, coalesce_threshold=coalesce_threshold, base_filename=img_fname, $
                                 n_endmembers=n_endmembers, method=method, $<span class="comments">;seg_fid=seg_fid, $</span>
                                 out_filename=out_filename, roi_out_filename=roi_out_filename, $
                                 endmember_cancel=endmember_cancel
    if endmember_cancel then begin
       if verbose then print, 'Endmember detection cancelled'
       goto, cleanup
    endif

    <span class="comments">;; do a new segmentation, if required</span>
    if (seg_fid eq -1) then begin <span class="comments">;; in-memory</span>
        if verbose then print,"Performing segmentation"
        hiihat_segment_ask_params, c=c, min_size=min_size, out_filename=seg_out_filename, $
                                   dist_metric=dist_metric, in_memory=seg_in_memory, $
                                   base_filename=img_fname, segment_cancel=segment_cancel
        if segment_cancel then begin
           <span class="comments">;;ok = dialog_message('Segmentation cancelled', title=title)</span>
           goto, cleanup
        endif

        hiihat_segment_felzenszwalb, img_fid, c, min_size, dist_metric, permute_segments=1, $
                                     r_fid=seg_fid, use_dims = use_dims, verbose=verbose, $
                                     in_memory=seg_in_memory, out_filename=seg_out_filename
                                     
    endif else begin
        envi_file_query, img_fid, nb = nb , nl = nl
        envi_file_query, seg_fid, nb = nb_seg, nl = nl_seg
        hiihat_assert, (nb ne nb_seg) or (nl ne nl_seg), "Image and segmentation file geometry must match" 
        seg_in_memory = 0
    endelse

    use_nfindr = (method eq "NFINDR")
    if roi_out_filename ne "" then begin 
        <span class="comments">;; call the endmember routine and write ROIs</span>
       hiihat_get_superpixel_endmembers, img_fid, seg_fid=seg_fid, $
              n_endmembers = n_endmembers, out_name_roi = roi_out_filename, $
              out_name_sli =out_filename, coalesce_threshold=coalesce_threshold, $
              use_dims = use_dims, verbose=verbose, use_nfindr=use_nfindr

    endif else begin      
       <span class="comments">;; get endmembers without writing ROIs</span>
       hiihat_get_superpixel_endmembers, img_fid, seg_fid=seg_fid, n_endmembers = n_endmembers, $
              out_name_sli =out_filename, coalesce_threshold=coalesce_threshold, $
              use_dims = use_dims, verbose=verbose, use_nfindr=use_nfindr
        
    endelse

    if verbose then print,"Endmember ROI's and spectra are now available"
cleanup:
    <span class="comments">; clean up</span>
    <span class="comments">;;if seg_in_memory then envi_file_mng, id=seg_fid, /remove</span>
    if debug then print,'Exiting '+title
end
  
</code>
    </div>
  </body>
</html>