<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:32 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_event_autoclass.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_event_autoclass.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+ </span>
<span class="comments">; Event callback for autoclass menu option. </span>
<span class="comments">;</span>
<span class="comments">; :Author: David Ray Thompson</span>
<span class="comments">;</span>
<span class="comments">; :Categories: </span>
<span class="comments">;  ui</span>
<span class="comments">;</span>
<span class="comments">; :Params:</span>
<span class="comments">;  ev: in, required, type=event</span>
<span class="comments">;   input event</span>
<span class="comments">;</span>
<span class="comments">; :Copyright: </span>
<span class="comments">;  Copyright 2009, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_event_autoclass:source"></a>pro hiihat_event_autoclass, ev     
    compile_opt strictarr

    title='hiihat_event_autoclass'

    <span class="comments">;; default parameters</span>
    verbose = hiihat_get_config_parm('verbose')
    debug = hiihat_get_config_parm('debug')
    gui_status = hiihat_get_config_parm('gui_status')
    robust_means = hiihat_get_config_parm('robust_means')

    if debug then print, "Entering "+title

    <span class="comments">;; load an image (code from the envi user guide)</span>
    envi_select, fid=unclipped_fid, title="Select an input image", $
                 dims = use_dims, /NO_SPEC
    if (unclipped_fid eq -1) then begin
       dialog = 'Invalid input image'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)                 
       goto, cleanup
    endif
    envi_file_query, unclipped_fid, wl = unclipped_wl, bnames = unclipped_bnames, $
                     dims=unclipped_dims, wavelength_units = wavelength_units, $
                     fwhm=unclipped_fwhm, fname=fname

    if keyword_set(use_dims) then unclipped_dims = use_dims

    <span class="comments">;; get preprocessing params</span>
    hiihat_preprocess_ask_params, image_type = image_type, base_filename=fname, $
                                  median_filter_width = median_filter_width, filter_negative=filter_negative, $
                                  norm_type = norm_type, div_type = div_type, $
                                  in_memory=preprocess_in_memory, out_filename=pp_out_filename, $
                                  preprocess_cancel = preprocess_cancel
    if preprocess_cancel then begin
       dialog='Preprocessing cancelled: no preprocessing will be perfomed'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)
    endif

    if not keyword_set(pp_out_filename) then pp_out_filename = fname

    <span class="comments">; query segmentation paramteters</span>
    hiihat_segment_ask_params, c=c, min_size=min_size, dist_metric=dist_metric, $
                               base_filename=pp_out_filename, out_filename=seg_filename, $
                               in_memory=seg_in_memory, segment_cancel=segment_cancel
    if segment_cancel then begin
       dialog = 'Segmentation cancelled'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)
       goto, cleanup
    endif

    <span class="comments">;; query endmember extraction parameters</span>
    hiihat_endmember_ask_params, coalesce_threshold=coalesce_threshold, $
                                 base_filename=pp_out_filename, n_endmembers=n_endmembers, $
                                 out_filename=endm_filename, roi_out_filename=roi_out_filename, $
                                 method=endm_method, endmember_cancel=endmember_cancel
    if endmember_cancel then begin
       dialog='Endmember detection cancelled'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)    
       goto, cleanup
    endif

    <span class="comments">;; choose classification parms</span>
    hiihat_classify_ask_params, class_method=class_method, method=method, base_filename=pp_out_filename, $
                                in_memory=class_in_memory, out_filename=class_out_filename, $
                                rule_in_memory=rule_in_memory, rule_out_filename=rule_out_filename, $
                                classify_cancel=classify_cancel                                                                                               
    if classify_cancel then begin
       dialog='Classification cancelled'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)    
       goto, cleanup
    endif

    if not preprocess_cancel then begin
       if verbose then print, "Preprocessing"       
       hiihat_preprocess, unclipped_fid, image_type = image_type, filter_negative=filter_negative, $
                          r_fid = img_fid, norm_type=norm_type, div_type=div_type, $
                          median_filter_width = median_filter_width, use_dims=unclipped_dims, $
                          in_memory=preprocess_in_memory, out_filename=pp_out_filename
       envi_file_query, img_fid, dims=img_dims, fwhm=img_fwhm, wl=img_wl, $
                        bnames=img_bnames
    endif else begin
       dialog="No preprocessing performed, using raw input image"
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)    
       img_fid = unclipped_fid
       img_dims = unclipped_dims
       img_fwhm = unclipped_fwhm
       img_wl = unclipped_wl
       img_bnames = unclipped_bnames
    endelse


    <span class="comments">;; check if there is a transform available for this image type</span>
    envi_file_query, img_fid, descrip=descrip
    image_pp_type=(stregex(descrip,'.*hiihat_pp: ([^\.]+)\.*', $
                        /EXTRACT, /FOLD_CASE, /SUBEXPR))[1]
    if image_pp_type eq '' then image_type = 'Unknown'
    hiihat_transform_ask_params, image_pp_type, trans_filename=trans_filename, $
                                 out_filename=trans_out_filename, in_memory=trans_in_memory, $
                                 max_rank=max_rank, base_filename=pp_out_filename, $ 
                                 verbose=verbose, transform_cancel=transform_cancel    

    if not transform_cancel then begin
       envi_open_file, trans_filename, r_fid=matrix_fid 
       if (matrix_fid eq -1) then begin
          dialog='Error opening transform file '
          if not gui_status then print, dialog else ok=dialog_message(dialog,title=title)                                      
          goto, cleanup
       endif

       if verbose then print, "Transforming image"  
       hiihat_apply_metric, img_fid, matrix_fid, trans_out_filename, r_fid = trans_r_fid,$
                            use_dims=use_dims, in_memory=trans_in_memory, verbose=verbose,$
                            rank=max_rank
    endif


    if verbose then print, "Segmenting"
    hiihat_segment_felzenszwalb, img_fid, c, min_size, dist_metric, $
                               r_fid=seg_fid, out_filename=seg_filename, $
                               in_memory=seg_in_memory

    if verbose then print, "Getting endmembers using method ", endm_method
    use_nfindr = (endm_method eq 'NFINDR')
    hiihat_get_superpixel_endmembers, img_fid, seg_fid=seg_fid, $
                                      n_endmembers=n_endmembers, $ <span class="comments">;number of endmembers to request</span>
                                      out_name_roi=roi_out_filename, $ <span class="comments">;roi endmember file outpath</span>
                                      out_name_sli=endm_filename, $ <span class="comments">; name of the sli file to generate for endmember spectra                                      </span>
                                      <span class="comments">;out_name_txt=endm_filename , $ ; the name of the txt wavelength file for endmember spectra</span>
                                      r_fid=endmember_fid, $ <span class="comments">; return fid for the endmember spectra</span>
                                      abund_r_fid=abund_r_fid, $ <span class="comments">; return fid for abundance image</span>
                                      coalesce_threshold=coalesce_threshold, $ <span class="comments">;</span>
                                      <span class="comments">;use_dims=img_dims, $ ; subsection of the image to process</span>
                                      use_nfindr=use_nfindr, $ <span class="comments">; Use the NFINDR algorithm (custom HIIHAT implementation)</span>
                                      <span class="comments">;ignore_segmentation=ignore_segmentation, $ ; Use entire image unsegmented (for comparison)</span>
                                      <span class="comments">;seed=seed, $ ; if used, the random seed for the NFINDR algorithm (optional)</span>
                                      <span class="comments">;in_memory=in_memory, $</span>
                                      verbose=verbose, $
                                      gui_status=gui_status

    if not keyword_set(endmember_fid) then begin
       dialog='Endmember detection failed'
       if not gui_status then print, dialog else ok=dialog_message(dialog, title=title)    
       goto, cleanup
    endif    

    <span class="comments">;; get the data back</span>
    envi_file_query, endmember_fid, ns = ns, dims = endmember_dims
    endmembers = envi_get_data(fid=endmember_fid, dims=endmember_dims, pos=0)

    hiihat_generate_class_colors, n_endmembers, class_names=class_names, $
                                  colors=colors

    pos = indgen(ns) <span class="comments">;; ns is the number of bands in the spectral library</span>
    <span class="comments">; do the classification</span>
    if verbose then print, "Classifying using method ",class_method
    envi_doit, 'CLASS_DOIT', fid=img_fid, mean=endmembers,$
        class_names = class_names, r_fid=r_fid, dims=img_dims, $
        method=method, out_name = class_out_filename, in_memory=class_in_memory, $
        pos=pos, lookup=colors, rule_in_memory=rule_in_memory, $
        rule_fid=rule_fid, rule_out_name=rule_out_filename

cleanup:
    if debug then print, "Exiting "+title
end
  

</code>
    </div>
  </body>
</html>