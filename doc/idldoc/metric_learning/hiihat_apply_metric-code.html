<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.3 on Wed Sep 14 19:26:29 2011 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hiihat_apply_metric.pro (HiiHAT)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hiihat_apply_metric.pro (HiiHAT)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+ </span>
<span class="comments">; Given an image and a precomputed LDA matrix transforms the image. </span>
<span class="comments">; The transformed image is maximally linearly separable with respect </span>
<span class="comments">; to the classes used to compute the LDA matrix.</span>
<span class="comments">;</span>
<span class="comments">; :Author: Brian Bue</span>
<span class="comments">;</span>
<span class="comments">; :Categories: </span>
<span class="comments">;  metric_learning</span>
<span class="comments">;</span>
<span class="comments">; :Params:</span>
<span class="comments">;  img_fid: in, required, type=fid</span>
<span class="comments">;    file id of image with a set of ROIs defining classes for metric learning</span>
<span class="comments">;  matrix_fid: in, required, type=fix</span>
<span class="comments">;    file id of intput matrix</span>
<span class="comments">;  out_filename: in, optional, type=string</span>
<span class="comments">;    name of output file to save transformed image</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;  use_dims: in, optional, type=size</span>
<span class="comments">;    spatial subset of input image</span>
<span class="comments">;  pos: in, optional, type=intarr(nb)</span>
<span class="comments">;    subset of spectral bands </span>
<span class="comments">;  r_fid: in, optional, type=fix</span>
<span class="comments">;    file id of returned image</span>
<span class="comments">;  in_memory: in, optional, type=boolean</span>
<span class="comments">;    store transformed image in memory</span>
<span class="comments">;  rank: in, optional, type=fix</span>
<span class="comments">;    rank of output transform </span>
<span class="comments">;  verbose: in, optional, type=boolean</span>
<span class="comments">;    print verbose output to console</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;  Copyright 2011, by the California Institute of Technology. ALL RIGHTS</span>
<span class="comments">;  RESERVED. United States Government Sponsorship acknowledged. Any commercial</span>
<span class="comments">;  use must be negotiated with the Office of Technology Transfer at the</span>
<span class="comments">;  California Institute of Technology.</span>
<span class="comments">; </span>
<span class="comments">;  This software may be subject to U.S. export control laws and regulations.  By</span>
<span class="comments">;  accepting this document, the user agrees to comply with all applicable U.S.</span>
<span class="comments">;  export laws and regulations.  User has the responsibility to obtain export</span>
<span class="comments">;  licenses, or other export authority as may be required before exporting such</span>
<span class="comments">;  information to foreign countries or providing access to foreign persons.</span>
<span class="comments">;-</span>
<a id="hiihat_apply_metric:source"></a>pro hiihat_apply_metric, img_fid, matrix_fid, out_filename, r_fid = r_fid,$
        pos=pos, use_dims=use_dims, in_memory=in_memory, verbose=verbose,$
        rank=rank

  <span class="comments">;; Set compiler and debug options</span>
  compile_opt strictarr

  debug = hiihat_get_config_parm('debug')
  finite_max = hiihat_get_config_parm('finite_max')
  
  mod_step = 5 <span class="comments">;; step for printing output </span>

  title='hiihat_apply_metric'
  if debug then print, "Entering "+title

  <span class="comments">;; ;; ...A may have lots of dimensions, so for a stopgap I'll </span>
  <span class="comments">;; ;; reduce this arbitrarily to lighten memory requirements</span>
  if not keyword_set(rank) then rank = 5

  <span class="comments">;; load the transform file</span>
  envi_file_query, matrix_fid, dims=trans_dims
  A = envi_get_data(fid=matrix_fid, dims=trans_dims, pos=0) 

  <span class="comments">;; load the image, correct for pos (bands), use_dims being smaller than whole image</span>
  if not keyword_set(pos) then begin
     envi_file_query, img_fid, nb=img_nb
     pos = lindgen(img_nb)
  endif
  img_nb = n_elements(pos)

  if (size(A))[1] ne img_nb then begin
     dialog='Image and transform dimensionality mismatch'
     ok=dialog_message(dialog,title=title)                                      
     goto, cleanup
  end    
  
  if keyword_set (use_dims) then begin 
     img_ns = use_dims[2]-use_dims[1]+1
     img_nl = use_dims[4]-use_dims[3]+1
     if verbose then print, "Reset img_ns, img_nl to",img_ns, img_nl
  endif else use_dims = img_dims
  
  <span class="comments">;; parse the image to transform</span>
  envi_report_init, "Loading image data", base=base, /INTERRUPT, title=title 
  envi_report_inc, base, img_nb-1
  lda_img = fltarr(img_ns*img_nl, img_nb)
  for i=0,img_nb-1 do begin
     if i mod mod_step eq 0 then begin
        envi_report_stat, base, i, img_nb-1, cancel=cancel   
        if cancel then goto, cleanup
     endif
     band = envi_get_data(fid=img_fid, dims=use_dims, pos=pos[i])
     lda_img[*,i] = reform(band,img_ns*img_nl)
  endfor   
  envi_report_init, base=base, /finish 

  <span class="comments">;; apply the transform</span>
  out_rank = (size(A))[2]
  lda_img = hiihat_apply_transform(lda_img, A)
  lda_img = reform(lda_img, img_ns, img_nl, out_rank, /overwrite)

  <span class="comments">;; output the resulting image for segmentation / endmember detection</span>
  double_type = 5
  envi_write_envi_file, lda_img, out_name=out_filename, $
                        in_memory=in_memory, $                        
                        data_type = double_type, $
                        dims = use_dims, $
                        nb = out_rank, $
                        nl = img_nl, $
                        ns = img_ns, $
                        r_fid = r_fid

cleanup:
    if debug then print, "Exiting "+title
end
</code>
    </div>
  </body>
</html>